# AOP
김영한님 Spring 핵심원리 - 고급편

<br>

### AOP - 핵심기능과 부가기능
* 핵심기능은 해당 객체가 제공하는 고유의 기능
* 부가기능은 핵심기능을 보조하기 위해 제공되는 기능
* 예) 로그추적로직, 트랜잭션 기능
* 이러한 부가기능은 단독으로 사용되지 않고, 핵심 기능과 함께 사용된다
* 보통 부가기능은 여러 클래스에 걸쳐서 함께 사용됨
* 이러한 부가 기능은 횡단 관심사가 됨

### 부가기능 적용 문제
* 부가 기능을 적용할 때 많은 반복이 필요함
* 부가 기능이 여러 곳에 퍼져서 중복 코드를 만들어냄
* 부가 기능을 변경할 때 중복 때문에 많은 수정이 필요함
* 부가 기능의 적용 대상을 변경할 때 많은 수정이 필요함
* *변경지점은 하나가 될 수 있도록 잘 모듈화 되어야함*

### Aspect
> 부가 기능을 어디에 적용할지 선택하는 기능을 합해서 하나의 모듈로 만든 것
* 부가 기능과, 해당 부가 기능을 어디에 적용할지 정의한 것
* 스프링이 제공하는 어드바이저도 어드바이스와 포인트컷을 가지고 있어서 개념상 하나의 Aspect임
* Aspect를 사용한 프로그래밍 방식을 관점 지향 프로그래밍(AOP)이라 함
* 횡단 관심사를 깔끔하게 처리하기 위한 보조 목적으로 개발됨

### AspectJ 프레임워크
> AOP의 대표적인 구현으로 AspectJ프레임 워크가 있다      
> 스프링도 AOP를 지원하나, 대부분 AspectJ문법을 차용하고, AspectJ가 제공하는 기능의 일부만 제공함
* 자바프로그래밍 언어에 대한 완벽한 관심지향 확장
* 횡단 관심사의 깔끔한 모듈화
    * 오류 검사 및 처리
    * 동기화
    * 성능 최적화(캐싱)
    * 모니터링 및 로깅

### AOP 적용 방식
* 컴파일 시점 ( 컴파일 타임 - 위빙)
  * Java소스코드를 컴파일러를 사용하여 .class를 만드는 시점에 부가 기능 로직을 추가할 수 있다
  * 이ㄷ 때는 AspectJ가 제공하는 특별한 컴파일러를 사용해야 함
  * 컴파일 된 .class에 Aspect관련 호출 코드가 들어감
  * AspectJ컴파일러는 Aspect를 확인해서 해당 클래스가 적용 대상인지 확인하고, 적용 대상인 경우 원본 로직에 부가 기능 로직을 적용함(위빙)
  * **단점**
    * 컴파일 시점에 부가 기능을 적용하려면 특별한 컴파일러도 필요하며, 복잡함
* 클래스 로딩 시점 ( 로드 타임 - 위빙)
  * 자바를 실행할 때 자바 언어는 .class파일을  JVM 내부의 클래스 로더에 보관함
  * 이 때 중간에서 .class파일을 조작한 다음 JVM에 올릴 수 있음
  * 자바 언어는 .class를 JVM에 저장하기 전에 조작할 수 있는 기능을 제공함
  * 이 시점에 Aspect를 적용하는 것을 로드 타임 위빙이라 함
  * **단점**
    * 로드타임 위빙은 자바를 실행할 때 특별한 옵션(java -javaagent)을 통해 클래스 로더 조작기를 지정하는데, 이 부분이 번거롭고 운영하기 어려움
* 런타임 시점 ( 런타임 - 위빙)
  * 컴파일 후 클래스 로더에 클래스가 로딩된 후 에 위빙 되는 것
  * 자바가 제공하는 범위 안에서 부가 기능을 적용해야함
  * 스프링과 같은 컨테이너의 도움을 받고 프록시와 DI,빈 포스트 프로세서 같은 개념들을 총 동원해야함
  * 최종적으로 프록시를 통해 스프링 빈에 부가 기능을 적용할 수 있음
* **부가 기능이 적용되는 차이**
  * 컴파일 시점
    > 실제 대상 코드에 애스팩트를 통한 부가 기능 호출 코드가 포함된다. AspectJ를 직접 사용해야 한다.
  * 클래스 로딩 시점
    > 실제 대상 코드에 애스팩트를 통한 부가 기능 호출 코드가 포함된다. AspectJ를 직접 사용해야 한다.
  * 런타임 시점
    > 실제 대상 코드는 그대로 유지된다. 대신에 프록시를 통해 부가 기능이 적용된다.      
    > 따라서 항상 프록 시를 통해야 부가 기능을 사용할 수 있다. 스프링 AOP는 이 방식을 사용한다.

### AOP적용 위치
> 메서드 실행 위치 뿐만 아니라 다양한 위치에 적용할 수 있음
* 적용 가능 지점(조인포인트)
  * 생성자, 필드 값 접근, static메서드 접근, 메서드 실행
* Aspect를 사용해서 컴파일 시점과 클래스 로딩 시점에 적용하는 AOP는 바이트코드를 실제 조작하기 때문에 해당 기능을 모든 지점에 다 적용 가능
* 프록시 방식을 사용하는 스프링 AOP는 메서드 실행 지점에만 AOP를 적용할 수 있음
  * 프록시 메서드 오버라이딩 개념으로 동작함
  * 따라서 생성자나 Static 메서드, 필드 값 접근에는 프록시 개념이 적용될 수 없음
* 프록시 방식을 사용하는 스프링 AOP는 스프링 컨테이너가 관리할 수 있는 스프링 빈에만 AOP적용 가능
* *스프링은 AspectJ의 문법을 차용하고 프록시 방식의 AOP를 사용하는것이며 직접 AspectJ를 사용하는 것이 아님*

### AOP용어 정리
* 조인 포인트(Join Point)
  * 어드바이스가 적용될 수 있는 위치, 메소드 실행, 생성자 호출, 필드 값 접근, static메서드 접근 같은 프로그램 실행 중 지점
  * 조인 포인트는 추상적인 개념
  * AOP를 적용할 수 있는 모든 지점
  * 스프링AOP는 프록시 방식을 사용하므로, 조인 포인트는 항상 메소드 실행 지점으로 제한된다.
* 포인트컷(Pointcut)
  * 조인포인트 중에서 어드바이스가 적용될 위치를 선별하는 기능
  * 주로 AspectJ표현식을 사용해서 지정
  * 프록시를 사용하는 스프링 AOP는 메서드 실행 지점만 포인트컷으로 선별 가능
* 타겟(Target)
  * 어드바이스를 받는 객체, 포인트 컷으로 결정
* 어드바이스(Advice)
  * 부가 기능
  * 특정 조인 포인트에서 Aspect에 의해 취해지는 조치
  * Around(주변), Before(전), After(후)와 같은 다양한 종류의 어드바이스가 있음
* 애스팩트(Aspect)
  * 어드바이스+포인트컷을 모듈화 한 것
  * @Aspect
  * 여러 어드바이스와 포인트 컷이 함께 존재
* 어드바이저(Advisor)
  * 하나의 어드바이스와 하나의 포인트 컷으로 구성
  * 스프링 AOP에서만 사용되는 특별한 용어
* 위빙(Weaving)
  * 포인트컷으로 결정한 타겟의 조인포인트에 어드바이스를 적용하는 것
  * 위빙을 통해 핵심 기능 코드에 영향을 주지 않고 부가 기능을 추가할 수 있음
  * AOP적용을 위해 애스팩트를 객체에 연결한 상태
    * 컴파일타임
    * 로드타임
    * 런타임, 스프링 AOP는 런타임, 프록시 방식
* AOP프록시
  * AOP 기능을 구현하기 위해 만든 프록시 객체, 스프링에서 AOP 프록시는 JDK 동적 프록시 또는, CGLIB프록시 이다
