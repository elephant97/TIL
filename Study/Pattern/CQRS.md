# CQRS 패턴

### CQRS(Command Query Responsibility Segregation) 패턴이란
> 명령과 쿼리를 분리하여 시스템의 복잡성을 줄이고 성능을 향상시키기 위해 사용됨
> 시스템의 상태를 변경하는 작업과 시스템의 상태를 반환하는 작업의 책임을 분리하는 것
* 명령(Command): 시스템의 상태를 변경하는 작업(예: 데이터 추가, 수정, 삭제)을 말함
* 쿼리(Query): 시스템의 상태를 조회하는 작업(예: 데이터 검색)을 말함
* CQRS는 이 두가지 작업을 명확히 분리하여 각각 최적화하고 관리함으로써, 더 유연하고 확장성 있는 시스템 아키텍처를 구축할 수 있도록 도움

### CQRS 패턴을 사용하는 이유
1. 명령과 쿼리가 다루는 데이터가 다르다
   * 명령의 경우 주로 한 영역의 데이터만 다루는 반면 쿼리는 시스템이 복잡해질수록 여러 영역의 데이터를 다루는 경향이 있음
   * 명령의 경우 해당 데이터만 변경하면 되지만, 쿼리의 경우 조회에 여러 영역의 데이터가 필요한 경우가 많다
2. 명령과 쿼리는 코드 변경 빈도나 사용자도 다르다
   * 변경 빈도나 사용자가 다른 기능의 코드가 한 코드에 있으면, 서로 다른 이유로 다른 시점에 코드가 변경되게 됨
   * 이는 책임의 크기가 적당하지 않은 것을 말하며 단일 책임 원칙에 위배됨
3. 기능마다 트래픽이나 성능 요구가 다름
   * 기능마다 적절한 성능 향상 방법이 다르다
   * 단일 모델로는 다양한 성능 향상 기법의 적용이 어려울 수 있음
4. 이는 객체지향의 핵심인 시스템의 요구사항인 협력을 분리하여 책임으로 나누고 책임을 수행할 역할을 가진 객체들의 상호작용의 개념과 정반대이다.
   * 따라서 명령과 쿼리를 분리하는 것

### CQRS의 장점
* 모델의 모호함이 사라진다
  * 명령 모델과 쿼리 모델이 무엇을 표현하고 있는지가 명확하다
  * 코드 가독성 유지 보수성이 높아짐
* 기능에 따라 성능 향상 기법을 적용하는 것이 용이해짐
  * 쿼리 쪽에는 캐시, 명령쪽에는 비동기를 적용할 수 있다.
 
### CQRS사용 시 주의할 점
> 명령과 쿼리를 다른 DB로 사용한다면 전파하는 방식이 다양해질 수 있다.
* 데이터 유실
  * 데이터 유실 허용 여부에 따라 DB트랜잭션 범위가 중요해진다.
* 허용 가능 지연 시간
  * 명령의 변경 내역을 얼마나 빨리 쿼리쪽에 반영해야 하느냐에 따라 구현의선택이 달라질 수 있다.
* 중복 전달
  * 쿼리쪽 DB에 변경된 데이터를 전달하는 과정에서 문제가 발생하기 되면, 다시 전달할 수 있는 수단이 필요하다.
  * 이런 수단을 만들게 되면 이미 반영된 데이터가 중복 전달되는 경우가 생길 수 있다.
  * 그래서 중복으로 데이터를 전달하더라도, 쿼리쪽 DB가 망가지지 않도록 별도의 조치가 필요하다.
